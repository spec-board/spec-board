name: CLA Check

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  check-cla:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      # Step 1: Welcome comment when PR is created
      - name: Welcome comment on new PR
        if: github.event.action == 'opened'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üëã Hello @${{ github.event.pull_request.user.login }}!
            
            Thank you for your contribution to this project. **Please reply this comment to confirm** after you have read the CLA.
            - Do you read the Contributor License Agreement?
            - Do you agree with the Contributor License Agreement?
            
            üôè Thank you!
      
      # Step 2: Check if PR uses template
      - name: Check if PR uses template
        id: check-template
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if echo "$PR_BODY" | grep -q "I have read and agree to the Contributor License Agreement"; then
            echo "has_template=true" >> $GITHUB_OUTPUT
          else
            echo "has_template=false" >> $GITHUB_OUTPUT
          fi
      
      # Step 3: Comment if template is missing
      - name: Comment if template missing
        if: steps.check-template.outputs.has_template == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è @${{ github.event.pull_request.user.login }}
            
            **Please create your Pull Request using the template!**
            
            1. Edit the current description OR create a new PR (close this PR).
            2. Using the [provided template](https://github.com/paulpham157/spec-board/blob/main/.github/PULL_REQUEST_TEMPLATE.md?plain=1)
            3. Fill in all required information according to the template
      
      # Step 4: Check if CLA checkbox is checked
      - name: Check CLA checkbox
        if: steps.check-template.outputs.has_template == 'true'
        id: check-cla
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if echo "$PR_BODY" | grep -qi '\[x\] I have read and agree to the Contributor License Agreement'; then
            echo "cla_checked=true" >> $GITHUB_OUTPUT
          else
            echo "cla_checked=false" >> $GITHUB_OUTPUT
          fi
      
      # Step 5: Comment if CLA is not checked
      - name: Comment if CLA not checked
        if: steps.check-template.outputs.has_template == 'true' && steps.check-cla.outputs.cla_checked == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è @${{ github.event.pull_request.user.login }}
            
            **Please read carefully and confirm the CLA in the checkbox!**
      
      # Step 6: Fail workflow if requirements are not met
      - name: Fail if requirements not met
        if: steps.check-template.outputs.has_template == 'false' || (steps.check-template.outputs.has_template == 'true' && steps.check-cla.outputs.cla_checked == 'false')
        run: |
          echo "‚ùå PR does not meet CLA requirements"
          exit 1
      
      # Step 7: Success message when CLA is checked
      - name: Success message
        if: steps.check-cla.outputs.cla_checked == 'true'
        run: |
          echo "‚úÖ CLA has been acknowledged. PR is ready for review!"
